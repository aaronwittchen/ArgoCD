version: 2.1

orbs:
  shellcheck: circleci/shellcheck@3.2.0

executors:
  default:
    docker:
      - image: cimg/base:current
    resource_class: small

jobs:
  yaml-lint:
    executor: default
    steps:
      - checkout
      - run:
          name: Install yamllint
          command: pip install yamllint
      - run:
          name: Run yamllint
          command: yamllint --format colored . || true

  kustomize-validate:
    executor: default
    steps:
      - checkout
      - run:
          name: Install Kustomize
          command: |
            curl -sL "https://github.com/kubernetes-sigs/kustomize/releases/download/kustomize%2Fv5.4.3/kustomize_v5.4.3_linux_amd64.tar.gz" | tar xz
            sudo mv kustomize /usr/local/bin/
      - run:
          name: Validate Kustomize overlays
          command: |
            echo "Validating Kustomize overlays..."
            for overlay in overlays/*/; do
              if [ -f "${overlay}kustomization.yaml" ]; then
                echo "Validating ${overlay}..."
                kustomize build "$overlay" > /dev/null && echo "  âœ“ ${overlay} is valid" || exit 1
              fi
            done

  kubeconform:
    executor: default
    steps:
      - checkout
      - run:
          name: Install Kustomize and Kubeconform
          command: |
            curl -sL "https://github.com/kubernetes-sigs/kustomize/releases/download/kustomize%2Fv5.4.3/kustomize_v5.4.3_linux_amd64.tar.gz" | tar xz
            sudo mv kustomize /usr/local/bin/
            curl -sL "https://github.com/yannh/kubeconform/releases/download/v0.6.7/kubeconform-linux-amd64.tar.gz" | tar xz
            sudo mv kubeconform /usr/local/bin/
      - run:
          name: Validate Kubernetes schemas
          command: |
            echo "Validating Kubernetes manifests..."
            for overlay in overlays/*/; do
              if [ -f "${overlay}kustomization.yaml" ]; then
                echo "Validating ${overlay}..."
                kustomize build "$overlay" 2>/dev/null | kubeconform \
                  -summary \
                  -strict \
                  -ignore-missing-schemas \
                  -schema-location default \
                  -schema-location 'https://raw.githubusercontent.com/datreeio/CRDs-catalog/main/{{.Group}}/{{.ResourceKind}}_{{.ResourceAPIVersion}}.json' \
                  || echo "Schema validation issues in ${overlay}"
              fi
            done

  trivy-scan:
    docker:
      - image: aquasec/trivy:latest
    resource_class: small
    steps:
      - checkout
      - run:
          name: Run Trivy IaC scan
          command: |
            trivy config \
              --severity CRITICAL,HIGH,MEDIUM \
              --exit-code 0 \
              --format table \
              .
      - run:
          name: Run Trivy filesystem scan
          command: |
            trivy fs \
              --severity CRITICAL,HIGH \
              --exit-code 0 \
              --format table \
              .

  shellcheck:
    executor: default
    steps:
      - checkout
      - run:
          name: Install ShellCheck
          command: sudo apt-get update && sudo apt-get install -y shellcheck
      - run:
          name: Find and check shell scripts
          command: |
            scripts=$(find . -type f \( -name "*.sh" -o -name "*.bash" \) | head -100)
            if [ -z "$scripts" ]; then
              echo "No shell scripts found"
            else
              echo "Found shell scripts:"
              echo "$scripts"
              echo "$scripts" | xargs shellcheck -e SC1091 -e SC2034 || true
            fi

workflows:
  validate:
    jobs:
      - yaml-lint
      - kustomize-validate
      - kubeconform:
          requires:
            - kustomize-validate
      - trivy-scan
      - shellcheck
