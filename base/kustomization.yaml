apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: argocd

resources:
  # Official ArgoCD installation
  - https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml
  # Custom resources
  - namespace.yaml
  # Gateway API (replaces NGINX Ingress)
  - gateway.yaml
  - httproute.yaml
  # NOTE: sops-age-secret.yaml is a template only - create the secret manually!
  # See sops-age-secret.yaml for instructions
  # NOTE: project-homelab.yaml must be applied AFTER ArgoCD is running:
  #   kubectl apply -f base/project-homelab.yaml

patches:
  # Enable KSOPS for SOPS decryption - ConfigMap
  - target:
      kind: ConfigMap
      name: argocd-cm
    patch: |-
      - op: add
        path: /data/kustomize.buildOptions
        value: "--enable-alpha-plugins --enable-exec"

  # Enable KSOPS for SOPS decryption - Repo Server init container
  - target:
      kind: Deployment
      name: argocd-repo-server
    patch: |-
      - op: add
        path: /spec/template/spec/initContainers/-
        value:
          name: install-ksops
          image: viaductoss/ksops:v4.3.2
          command: ["/bin/sh", "-c"]
          args:
            - |
              echo "Installing KSOPS and SOPS..."
              cp /usr/local/bin/ksops /custom-tools/
              cp /usr/local/bin/kustomize /custom-tools/
              cp /usr/local/bin/sops /custom-tools/
              echo "KSOPS installation complete"
          resources:
            requests:
              cpu: 50m
              memory: 64Mi
              ephemeral-storage: 64Mi
            limits:
              cpu: 100m
              memory: 128Mi
              ephemeral-storage: 256Mi
          volumeMounts:
            - mountPath: /custom-tools
              name: custom-tools
      - op: add
        path: /spec/template/spec/volumes/-
        value:
          name: sops-age-key
          secret:
            secretName: sops-age-key
            optional: true
      - op: add
        path: /spec/template/spec/volumes/-
        value:
          name: custom-tools
          emptyDir: {}
      - op: add
        path: /spec/template/spec/containers/0/volumeMounts/-
        value:
          mountPath: /sops-age
          name: sops-age-key
      - op: add
        path: /spec/template/spec/containers/0/volumeMounts/-
        value:
          mountPath: /usr/local/bin/ksops
          name: custom-tools
          subPath: ksops
      - op: add
        path: /spec/template/spec/containers/0/volumeMounts/-
        value:
          mountPath: /usr/local/bin/kustomize
          name: custom-tools
          subPath: kustomize
      - op: add
        path: /spec/template/spec/containers/0/volumeMounts/-
        value:
          mountPath: /usr/local/bin/sops
          name: custom-tools
          subPath: sops
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: XDG_CONFIG_HOME
          value: /.config
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: SOPS_AGE_KEY_FILE
          value: /sops-age/keys.txt

  # Reduce resources for argocd-server and enable insecure mode for HTTP
  - target:
      kind: Deployment
      name: argocd-server
    patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/resources
        value:
          requests:
            cpu: 100m
            memory: 128Mi
            ephemeral-storage: 128Mi
          limits:
            cpu: 200m
            memory: 256Mi
            ephemeral-storage: 512Mi
      - op: add
        path: /spec/template/spec/containers/0/args/-
        value: "--insecure"

  # Reduce resources for application-controller
  - target:
      kind: StatefulSet
      name: argocd-application-controller
    patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/resources
        value:
          requests:
            cpu: 250m
            memory: 512Mi
            ephemeral-storage: 256Mi
          limits:
            cpu: 500m
            memory: 1Gi
            ephemeral-storage: 1Gi
