apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: argocd

resources:
  # Official ArgoCD installation
  - https://raw.githubusercontent.com/argoproj/argo-cd/v2.13.3/manifests/install.yaml
  # Custom resources
  - namespace.yaml
  - networkpolicy.yaml
  # HTTPRoute for Istio Gateway (uses existing cluster-gateway in istio-system)
  - httproute.yaml
  # NOTE: sops-age-secret.yaml is a template only - create the secret manually!
  # See sops-age-secret.yaml for instructions
  # NOTE: project-homelab.yaml must be applied AFTER ArgoCD is running:
  #   kubectl apply -f base/project-homelab.yaml

patches:
  # Enable KSOPS for SOPS decryption - ConfigMap (strategic merge patch)
  - target:
      kind: ConfigMap
      name: argocd-cm
    patch: |-
      apiVersion: v1
      kind: ConfigMap
      metadata:
        name: argocd-cm
      data:
        kustomize.buildOptions: "--enable-alpha-plugins --enable-exec"

  # Enable KSOPS for SOPS decryption - Repo Server init containers
  - target:
      kind: Deployment
      name: argocd-repo-server
    patch: |-
      - op: add
        path: /spec/template/spec/initContainers/-
        value:
          name: install-ksops
          image: viaductoss/ksops:v4.3.2
          command: ["/bin/sh", "-c"]
          args:
            - |
              echo "Installing KSOPS..."
              cp /usr/local/bin/ksops /custom-tools/
              cp /usr/local/bin/kustomize /custom-tools/
              echo "KSOPS installation complete"
          securityContext:
            allowPrivilegeEscalation: false
            runAsNonRoot: true
            runAsUser: 999
            capabilities:
              drop:
                - ALL
            seccompProfile:
              type: RuntimeDefault
          resources:
            requests:
              cpu: 50m
              memory: 64Mi
              ephemeral-storage: 64Mi
            limits:
              cpu: 100m
              memory: 128Mi
              ephemeral-storage: 256Mi
          volumeMounts:
            - mountPath: /custom-tools
              name: custom-tools
      - op: add
        path: /spec/template/spec/initContainers/-
        value:
          name: install-sops
          image: alpine@sha256:765942a4039992336de8dd5db680586e1a206607dd06170ff0a37267a9e01958 # alpine:3.20
          command: ["/bin/sh", "-c"]
          args:
            - |
              echo "Installing SOPS..."
              wget -qO /custom-tools/sops https://github.com/getsops/sops/releases/download/v3.11.0/sops-v3.11.0.linux.amd64
              chmod +x /custom-tools/sops
              echo "SOPS installation complete"
          securityContext:
            allowPrivilegeEscalation: false
            runAsNonRoot: true
            runAsUser: 65534
            capabilities:
              drop:
                - ALL
            seccompProfile:
              type: RuntimeDefault
          resources:
            requests:
              cpu: 50m
              memory: 64Mi
              ephemeral-storage: 64Mi
            limits:
              cpu: 100m
              memory: 128Mi
              ephemeral-storage: 256Mi
          volumeMounts:
            - mountPath: /custom-tools
              name: custom-tools
      - op: add
        path: /spec/template/spec/volumes/-
        value:
          name: sops-age-key
          secret:
            secretName: sops-age-key
            optional: true
      - op: add
        path: /spec/template/spec/volumes/-
        value:
          name: custom-tools
          emptyDir: {}
      - op: add
        path: /spec/template/spec/containers/0/volumeMounts/-
        value:
          mountPath: /sops-age
          name: sops-age-key
      - op: add
        path: /spec/template/spec/containers/0/volumeMounts/-
        value:
          mountPath: /usr/local/bin/ksops
          name: custom-tools
          subPath: ksops
      - op: add
        path: /spec/template/spec/containers/0/volumeMounts/-
        value:
          mountPath: /usr/local/bin/kustomize
          name: custom-tools
          subPath: kustomize
      - op: add
        path: /spec/template/spec/containers/0/volumeMounts/-
        value:
          mountPath: /usr/local/bin/sops
          name: custom-tools
          subPath: sops
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: XDG_CONFIG_HOME
          value: /.config
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: SOPS_AGE_KEY_FILE
          value: /sops-age/keys.txt
      # Set resources for repo-server (needs more ephemeral storage for git clones)
      - op: replace
        path: /spec/template/spec/containers/0/resources
        value:
          requests:
            cpu: 100m
            memory: 256Mi
            ephemeral-storage: 1Gi
          limits:
            cpu: 500m
            memory: 512Mi
            ephemeral-storage: 4Gi

  # Reduce resources for argocd-server and enable insecure mode for HTTP
  - target:
      kind: Deployment
      name: argocd-server
    patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/resources
        value:
          requests:
            cpu: 100m
            memory: 128Mi
            ephemeral-storage: 128Mi
          limits:
            cpu: 200m
            memory: 256Mi
            ephemeral-storage: 512Mi
      - op: add
        path: /spec/template/spec/containers/0/args/-
        value: "--insecure"

  # Reduce resources for application-controller
  - target:
      kind: StatefulSet
      name: argocd-application-controller
    patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/resources
        value:
          requests:
            cpu: 250m
            memory: 512Mi
            ephemeral-storage: 256Mi
          limits:
            cpu: 500m
            memory: 1Gi
            ephemeral-storage: 1Gi
